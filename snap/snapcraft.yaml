name: tf-label-image
summary: Label an image using TensorFlow Lite
description: This snap provides a utility that consumes an image file and outputs a list of labels, along with a certainty percentage.
version: 0.0.2

confinement: strict
grade: devel
license: Apache-2.0

base: core24

platforms:
  amd64:
  arm64:

package-repositories:
  - type: apt
    ppa: deadsnakes/ppa
  - type: apt
    components: [main]
    suites: [coral-edgetpu-stable]
    # The gpg key for this repo is stored in .snap/keys/DC6315A3.asc as documented at https://snapcraft.io/docs/package-repositories#heading--keyid
    key-id: 35BAA0B33E9EB396F59CA838C0BA5CE6DC6315A3
    url: https://packages.cloud.google.com/apt

parts:
  python38:
    plugin: nil
    stage-packages:
      - python3.8-full
      - python3.8-distutils
      - python3.8-venv
      - python3-pip
      - libusb-1.0-0
      - libedgetpu1-std

  python-dependencies:
    after: [ python38 ]
    plugin: python
    build-environment:
      - PARTS_PYTHON_INTERPRETER: python3.8
    python-packages:
      - numpy<2
      - pillow
      - tflite-runtime
      - opencv-python-headless
      - tflite_support
      - flask
    source: .

  # To install pycoral see https://github.com/tensorflow/tensorflow/issues/53110#issuecomment-977326183
  pycoral:
    after: [python38]
    plugin: nil
    override-build: |
      python3.8 -m pip install --extra-index-url https://google-coral.github.io/py-repo/ pycoral~=2.0

  scripts:
    plugin: dump
    source: .
    override-build: |
      cp help.py $CRAFT_PART_INSTALL/
      cp utils.py $CRAFT_PART_INSTALL/
      cp image_label.py $CRAFT_PART_INSTALL/
      cp image_detect.py $CRAFT_PART_INSTALL/
      cp camera_detect.py $CRAFT_PART_INSTALL/
      cp camera_detect_stream.py $CRAFT_PART_INSTALL/

  label-model:
    plugin: dump
    source: https://storage.googleapis.com/download.tensorflow.org/models/mobilenet_v1_2018_02_22/mobilenet_v1_1.0_224.tgz
    source-type: tar
    source-checksum: sha256/1ccb74dbd9c5f7aea879120614e91617db9534bdfaa53dfea54b7c14162e126b
    override-build: |
      chmod a=r mobilenet_v1_1.0_224.tflite
      cp mobilenet_v1_1.0_224.tflite $CRAFT_PART_INSTALL/

  labels:
    plugin: dump
    source: https://storage.googleapis.com/download.tensorflow.org/models/mobilenet_v1_1.0_224_frozen.tgz
    source-type: tar
    source-checksum: sha256/366a2d53008df0d2a82b375e2020bbc57e43bbe19971370e47b7f74ea0aaab91
    override-build: |
      chmod a=r labels.txt
      cp labels.txt $CRAFT_PART_INSTALL/

  detect-model:
    plugin: dump
    source: https://storage.googleapis.com/download.tensorflow.org/models/tflite/task_library/object_detection/rpi/lite-model_efficientdet_lite0_detection_metadata_1.tflite
    source-type: file
    source-checksum: sha256/2e04c53bfeac0ac2a30c057c7e2a777594ce39baaac35a92f74fb1e8c4fc4e0b
    override-build: |
      chmod a=r lite-model_efficientdet_lite0_detection_metadata_1.tflite
      cp lite-model_efficientdet_lite0_detection_metadata_1.tflite $CRAFT_PART_INSTALL/efficientdet_lite0.tflite

  detect-model-tpu:
    plugin: dump
    source: https://storage.googleapis.com/download.tensorflow.org/models/tflite/task_library/object_detection/rpi/efficientdet_lite0_edgetpu_metadata.tflite
    source-type: file
    source-checksum: sha256/a3cc0baf52939ca20f45c70b3e8d2e7cb2f66a6f46576024f5301f9794cf5d78
    override-build: |
      chmod a=r efficientdet_lite0_edgetpu_metadata.tflite
      cp efficientdet_lite0_edgetpu_metadata.tflite $CRAFT_PART_INSTALL/efficientdet_lite0_edgetpu.tflite

  test-data:
    plugin: dump
    source: https://raw.githubusercontent.com/tensorflow/tensorflow/master/tensorflow/lite/examples/label_image/testdata/grace_hopper.bmp
    source-type: file
    source-checksum: sha256/8c1165a143b3ac5c37fba13a918101133d549d3419c7fc474ae70a2f29263b80
    override-build: |
      chmod a=r grace_hopper.bmp
      cp grace_hopper.bmp $CRAFT_PART_INSTALL/

apps:
  tf-label-image:
    command: bin/python3 $SNAP/help.py

  image-label:
    plugs:
      - home
    command: bin/python3 $SNAP/image_label.py

  image-detect:
    plugs:
      - home
      - raw-usb
    command: bin/python3 $SNAP/image_detect.py

  camera-detect:
    plugs:
      - home
      - camera
      - raw-usb
    command: bin/python3 $SNAP/camera_detect.py

  camera-detect-stream:
    plugs: &_plugs
      - home
      - camera
      - network-bind
      - raw-usb
    command: &_command bin/python3 $SNAP/camera_detect_stream.py

  daemon:
    daemon: simple
    restart-delay: 3s
    restart-condition: always
    plugs: *_plugs
    command: *_command

  python:
    plugs:
      - home
    command: bin/python3
